---
title: "Introducción al Tratamiento de Imágenes Satélite"
author: "Vanessa Covrig Covrig y Estrella Dominguez Sanchez"
date: ''
output:
  html_document:
    fig_caption: yes
    number_sections: no
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    df_print: kable
    latex_engine: xelatex
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 3
  word_document:
    toc: yes
    toc_depth: '3'
always_allow_html: yes
---
<style>
body h2 {
  font-size: 20px;
  color: blue;
}
</style>

<style>
body h1 {
  font-weight: bold;
  font-size: 30px;
  color: ;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.aling="center")
```

# Introducción a las Imágenes Satelitales

## ¿Qué es una imagen satélite?

Las imágenes satélites son fotografías tomadas por satélites artificiales, que muestran la geografía de un territorio específico o el espectro determinado de ondas electromagnéticas.

## ¿Pór que necesitamos procesar las imágenes satelitales?

El procesamiento de imágenes implica la manipulación e interpretación de imágenes digitales con la ayuda de un ordenador.
El propósito del procesamiento digital de imágenes satelitales es muy variado, desde el de resaltar elementos que son difíciles de percibir o no se pueden distinguir directamente en una imagen, ver la superficie terrestre desde decenas de kilometros por encima del mar, hasta crear una variedad de productos, como mapas de uso del suelo, mapas de elevación, mapas de riesgo de inundación...

## Conceptos  y características de imágenes satelitales
 **Resolución espectral:** Número y ancho de las bandas del espectro electromagnético que el satélite puede    detectar.  <br></br><br> 
 <center>![Espectro electromagnético](img/bandaesp.png)</center> </br>
 **Resolución espacial:** Tamaño real de la menor unidad de la imagen que puede ser observada.  
 **Resolución temporal:** Tiempo que tarda el satélite en volver a tomar una imágenes en la misma posición.  
 **Proyección y Sistema de Coordenadas:** Es importante saber el sistema de coordenadas que usan las imagenes   satelitales para poder ubicarlas en el espacio.  
 
# Tratamiento de Imágenes Satelitales
El tratamiento de imágenes satelitales tiene un amplio campo de estudio y trabajo, por lo que solo vamos a tratar estos campos básicos:  

* Paquetes necesarios  
* Descarga de imágenes satelitales   
* Cálculo de estadísticas de imágenes  
* Cálculo de índices aplicados a las imágenes

# Paquetes de R para trabajar con Imágenes Satelitales
## Sen2r

Este paquete de R nos ayuda a descargar y procesar las imagenes Sentinel-2 (2 satélites     multiespectrales de órbita polar, para la monitorización de la Tierra.) 
Para el correcto funcionamiento de este paquete necesitaremos instalar otros paquetes más básicos como "leafpm", "mapedit", "shinyFiles", "shinydashboard", "shinyjs", "shinyWidgets".

## Raster
Este paquete nos permite la manipulación y análisis de datos geoespaciales de las imagenes satelitales anteriormente procesadas con Sen2r.

## Otros paquetes

**Getlandsat**  

El paquete getlandsat nos facilita el acceso a las imágenes Landsat 8 (Las imágenes Landsat 8 obtenidas por el sensor (OLI) y (TIRS) constan de nueve bandas espectrales con una resolución espacial de 30 metros para las bandas de 1-7)
    
**MODIS**    
    
El paquete MODIS para trabajar con imágenes satélite nos permite procesar y obtener archivos de LP DAAC, LAADS y NSIDC (Moderate-Resolution Imaging Spectroradiometer (MODIS) es un instrumento científico lanzado por la NASA en 1999 a bordo del satélite Terra (EOS AM) y en 2002 a bordo del satélite Aqua. Permite medir la temperatura de la superficie, los sedimentos y fitoplancton del océano...)
  

# Descarga de Imágenes Satelitales
## Sen2r y Copernicus
Actualmente, existen infinidad de páginas web donde se nos permite obtener imágenes satelitales de forma gratuita como: Google Earth Engine o USGS Earth Explorer (Servicio Geológico de los Estados Unidos) pero Sen2r nos facilita todo este trabajo, permitiéndonos descargar las imágenes que deseemos de Copernicus Open Access Hub, específicamente podemos descargar imágenes del Sentinel-2 que monitorizan la Tierra, Sen2r nos permite especificar la fecha y escena en la que queremos trabajar facilitandonos mucho el trabajo a la hora de descargar las imágenes satelitales.

# Cálculo de estadísticas de Imágenes Satelitales
Las imágenes satelitales proporcionan una gran cantidad de datos que se pueden utilizar para realizar análisis estadísticos y obtener información valiosa sobre la superficie de la Tierra.  
Existen varias técnicas estadísticas como:  

* Estadísticas descriptivas  
* Análisis de histogramas  
* Análisis de tendencias y cambios  
* Análisis de correlación  
* Clasificación y segmentación  
* Análisis de series temporales  

## Análisis de histogramas en Imágenes Satelitales
Un histograma es un gráfico en el que se representa una distribución de frecuencias de una variable.  
Está formado por:   
  
* Eje X: Valores de la variable  
* Eje Y: Frecuencias (veces que aparece el valor)  

Ya que las imágenes satelitales disponen de varias bandas electromagnéticas, al hacer un histograma podemos elegir con cuál trabajar, cada banda nos proporcionara una información distinta sobre la imagen satelital.
Las bandas comunes utilizadas en las imágenes satelitales son:
  
**Banda azul:**  Esta banda corresponde a la región del espectro visible (al ojo humano) junto a las bandas verde y roja. Esta banda nos permite distinguir cuerpos de agua, hielo, ciertos tipos de nubes y áreas urbanas, esta banda trabaja con la claridad u oscuridad de las imágenes para identificar los distintos cuerpos mencionados.  
   
**Banda verde:** La banda verde es útil para identificar áreas de vegetación, como bosques, cultivos y pastizales. 
  
**Banda roja:** La banda roja es útil para evaluar la salud y densidad de la vegetación, así como para distinguir características geológicas.  
  
**Banda infrarroja cercana:** La banda infrarroja cercana pertenece al espectro electromagnetico no visible junto a la infrarroja de onda corta, esta banda se utiliza para evaluar la salud y vigor de la vegetación, así como para identificar cuerpos de agua y características del suelo.   

# Cálculo de índices aplicados a las Imágenes Satelitales
El cálculo de índices  es una técnica utilizada para obtener información sobre características o fenómenos de interés en la superficie terrestre. Los índices se calculan utilizando combinaciones de las bandas espectrales de una imagen y se utilizan para cuantificar propiedades como la vegetación, el contenido de agua, la salud de los cultivos, la calidad del suelo y más...  
Algunos tipos de índices aplicados que vamos a utilizar:   

* NDVI: Contrasta la diferencia entre la banda del rojo y del infrarrojo cercano; puede ofrecer debilidades a la hora de enmascarar superficies relativamente distintas. Los colores altos corresponden a zonas de vegetación.  

* NDWI: Se utiliza para detectar masas de agua.  

* NBR: Se utiliza para detectar áreas afectadas por incendios.  


# Ejemplo practico con Sen2r

Hemos decidido usar el paquete Sen2r debido a su facilidad de manejo, ya que dispone de una interfaz, la cual se puede configurar dependiendo de las intenciones de cada usuario, además de un procesamiento integrado el cual nos facilita el preprocesamiento de las imagénes satélite.

## Primeros pasos con Sen2r
Primero necesitaremos registrarnos en esta página para poder acceder a las imágenes satélite y a las funciones del paquete: https://scihub.copernicus.eu/dhus/#/home

Después de registrarnos ejecutaremos el paquete Sen2r junto a unas librerias necesarias para su correcto funcionamiento e iniciaremos sesión con las credenciales anteriores que hayamos introducido.

```{r eval = FALSE}
library(sen2r())
write_scihub_login(username = "vancovx", password = "trabajomates")

library(leafpm)
library(mapedit)
library(shinyFiles)
library(shinydashboard)
library(shinyjs)
library(shinyWidgets)

```
## Importación de imágenes
Para importar las imágenes necesitamos especificar un par de parámetros explicados a continuación: 
```{r eval = FALSE}
#Definimos una ventana temporal para buscar entre esas dos fechas
time_window <- as.Date(c("2020-05-01","2020-05-05"))
#Definimos la escena en la que vamos a trabajar (El tile); 30TXM es de Zaragoza
tile = "30TXM"
#Porcentaje de nubes maximo que aparecera en nuestra imagen
max_cloud = 20

```
Después comprobamos el recibimiento de imágenes y descargamos la imagen en un directorio.
```{r eval = FALSE}
#Comprobamos que existen imágenes con esas caracteristicas
list_safe <- s2_list(tile = tile, time_interval = time_window, max_cloud = max_cloud)

#Comprobamos los metadatos que nos devuelve la lista anterior
safe_getMetadata(list_safe, "sensing_datetime")
safe_getMetadata(list_safe, "nameinfo")

#Creamos un directorio para descargar ahi la imagen
path <- "C:/Users/vanes/OneDrive/Trabajo/"

#Le añadimos una carpeta nueva a la ruta anterior
path_save <- paste0(path,"prueba/")
dir.create(path_save)

#Guardamos la imagen en la ruta creada
s2_download(list_safe, outdir = path_save)

#Creamos un directorio que contiene todas las carpetas
dirs <- list.dirs(path = path_save)

#Aplicamos un filtro para que nos seleccione solamente las carpetas que contienen "IMG_DATA", que es la carpeta que contiene todas las imagenes
dirs <- dirs[grep("IMG_DATA", dirs)]

#Creamos una variable que liste todos los archivos de la carpeta
v_files <- list.files(dirs[1], full.names = TRUE, recursive = TRUE)

#Accedemos al objeto 2 (empieza desde la posicion 1)
print(v_files[2])

#Filtramos los archivos para que nos selecciones solamente los que terminan por 20m.jp2
v_files <- list.files(path = path_save, pattern = "20m.jp2", full.names = TRUE, recursive = TRUE)
```


```{r eval = FALSE}
#LIBRERIA RASTER
#instalamos la libreria
library(sp) #esta es requerida para usar raster
library(raster)

#COLOREAR IMAGEN EN COLOR VERDADERO
#elegimos el objeto 12
plotRGB(stack(v_files[12]), red = 1, green = 2, blue = 3)

#cargamos la banda 2 (azul) desde el archivo
b02 <- raster(v_files[2])
plot(b02)

#una vez tenemos cargada la banda:
#EXPLORAMOS LA INFORMACIÓN DE LA IMAGEN

#accedemos a la proyeccion: obtencion de datos:
crs(b02) #CRS
res(b02) #Resolución X - y
xres(b02) #Resolución X
yres(b02) #Resolución Y
ncell(b02) #número de celdas
dim(b02) #dimensiones
extent(b02) #Estensión x-y

#guardamos los valores del raster en un objeto
b02_hist <- getValues(b02)
head(b02_hist)

#generamos un histograma
par(mar=c(4,4,4,4))
hist(b02_hist, breaks=5000, xlim=c(0,3000)) #definimos los margenes e intervalos





```
















# Bibliografía

